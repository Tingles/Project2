
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include "./setup.h"

/*globals*/
static CodeIndex      CountryIndex;
static CountryStorage ActualDataStorage;

/*forward declaration of meta type*/


  
int main(int argc, char * argv[]){
  
  extern Storage array_ops;
  extern Storage bst_ops;
  FILE *input;
  char buff[linemax];
  Meta header = {0,0,0};
  

  if((input = fopen("../backup.bin","rb+")) == NULL){
    printf("Problem opening data file.\n");
    exit(EXIT_FAILURE);
  }
  /*read header record for file meta data.*/
  header = readheader(input);
  
  /*specify backend storage/index methods.*/
  CountryIndex.ops = bst_ops;
  ActualDataStorage.ops = array_ops;

  /*initalize data structures*/
  initialize_env(&ActualDataStorage, &CountryIndex, &header);
  /*
   *read datastructures from binary backup.  Index must be read first because thats
   * how it was written out.
   */
  (CountryIndex.ops.load) (&CountryIndex, input);
  (ActualDataStorage.ops.load) (&ActualDataStorage, input);
  
  /*Done loding data from backup, open stream for transaction.*/
  fclose(input);
  if ((input = fopen(argv[1], "r")) == 0){
    printf("Problem opening data file.\n%m\n");
    exit(EXIT_FAILURE);
  }
  while(fgets(buff,linemax,input) != 0){
    char *target, *action;
    ActionCode AC;
    target = strip(parsetransrec(buff));
    action = buff;
    AC = action2enum(action);
    switch(AC){
    case Query_name:{
      (ActualDataStorage.ops.query) (&ActualDataStorage, &AC, target);
      /*sequential search through ActualDataStorage.*/
    }break;
    case Query_keyid:{
      /*
       *Direct address in ActualDataStorage, record is either there or it's not.
       */
      //      (ActualDataStorage.ops.query)(&ActualDataStorage, AC, target);
    }break;
    case Query_code:{
      /*
       *BST walk through CodeIndex, at worst case the # of comparisons is 
       * the height of the tree.
       */
    }break;
    case List_keyid:{
      /*
       *List all countries by Id. This could be a sequential traversal over 
       * ActualDataStorage.
       */
    }break;
    case List_code:{
      /*
       *List all countries by Code. Implementation is an *inorder* traversal of
       *  our BST.
       */
    }break;
    default:break;
    }
    
  }
  
  
}
